(function(q,n){"object"===typeof exports&&"undefined"!==typeof module?n(exports):"function"===typeof define&&define.amd?define("DCAgent",["exports"],n):n(q.DCAgent={})})(this,function(q){function n(){}function ha(a){var b,c;b=Date.now();c="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var c;c=(b+16*Math.random())%16|0;b=Math.floor(b/16);return"x"===a?c.toString(16):(c&7|8).toString(16)});return(a||"")+c.replace(/-/g,"").toUpperCase()}function ia(a){var b,c;for(b in a)c=a[b],a[b]=
c;(2<=arguments.length?[].slice.call(arguments,1):[]).forEach(function(e){var f;f=[];for(b in e)c=e[b],f.push(a[b]=c);return f});return a}function k(a,b,c){if("function"===typeof a)try{return a.apply(b,c)}catch(e){h("attemp error for "+a.toString(),e.stack)}}function ja(a,b,c){function e(){!1!==k(a)&&I(e,b)}c?e():I(e,b)}function h(a,b){console.log("#DCAgent: "+a);b&&console.log(b)}function y(a,b){a=m(a);r.setItem(a,b);R.set(a,b,365);return b}function C(a){a=m(a);return r.getItem(a)||R.get(a)}function m(a){if(J||
K===a)return a;d.appId||h("appid should not be empty when you are in native env");return d.appId+"."+a}function ka(a){var b=u.hash,c="!"+a;if(b){var e=/![0-9A-Z]{32,128}/gi;(b=b.match(e))?(b=b[0].slice(1),a===b||C(S)||(d.parentId=b,y(S,b)),u.href=u.href.replace(e,c)):u.href+=c}else u.href+="#"+c}function T(a,b,c,e){var f={data:{online:{},events:a||[],errors:b||[]},success:e};c&&(f.data.reg=c);a=L(z);b=L(D);if(a.length||b.length)r.removeItem(m(z)),r.removeItem(m(D)),f.data.events=f.data.events.concat(a),
f.data.errors=f.data.errors.concat(b),f.error=function(){d.debug&&h("report failed, restoring data to localStorage");E(f.data.events,z);E(f.data.errors,D)};U(f,V)}function W(a,b,c){a={page:encodeURIComponent(a||la),optime:parseInt(d.initializedOn),ottime:parseInt(Date.now()/1E3),lttime:parseInt(d.loginTime/1E3)};T([{eventid:"_DESelf_PV",labelmap:JSON.stringify(a),duration:"1"}],null,b,function(){M+=1;k(c)})}function ma(){if(!d.appId||!d.accountId||!d.deviceId)return h("DCAgent.init failed, check your options"),
{};var a=d.intervalCount*d.interval/1E3||1;return{appid:d.appId,accountid:d.accountId,uid:d.deviceId,appver:d.appVer,ver:X,channel:d.channel,domain:na,screen:oa,logintime:String(parseInt(d.loginTime/1E3)),onlinetime:String(a),crtime:C(A)||"",pv:M.toString()}}function pa(a){var b=new g.XMLHttpRequest;b.timeout=Y;b.open("POST",a.url,!0);b.setRequestHeader("Content-Type","text/plain; charset=UTF-8");var c=Date.now();b.onreadystatechange=function(){if(4===this.readyState){var b=200<=this.status&&300>
this.status,f=Date.now()-c;k(b?a.success:a.error,this,[this,f]);k(a.complete,this,[this,f]);this.timeout=this.onreadystatechange=null}};b.timeout=function(){var b=Date.now()-c;k(a.error,this,[this,b,!0]);k(a.complete,this,[this,b]);this.timeout=this.onreadystatechange=null};b.send(JSON.stringify(a.data))}function qa(a){var b=new egret.URLLoader,c=Date.now();b.addEventListener(egret.Event.COMPLETE,function(b){var e=Date.now()-c;b=b.target;k("success"===b.data?a.success:a.error,b,[b,e,e>=Y]);k(a.complete,
b,[b,e])});var e=new egret.URLRequest(a.url);e.method=egret.URLRequestMethod.POST;e.data=JSON.stringify(a.data);b.load(e)}function U(a,b){if(a.data){a.data.errors&&a.data.errors.length>v.max&&(d.debug&&h("sending too many errors, only "+v.max+" allowed"),a.data.errors=a.data.errors.slice(0,v.max));for(var c in a.data)"number"===typeof a.data[c]&&(a.data[c]=String(a.data[c]));c=Math.abs(d.onlinetime);c>ra||0>=c?d.debug&&h("illegal online time: "+c):(c=ia({headers:ma()},a.data),sa({url:b,data:c,success:function(b,
c){t.succ=1;t.fail=0;t.total=c;k(a.success,b,[b,c])},error:function(b,c,g){t.succ=0;t.fail+=1;t.total+=c;k(a.error,b,[b,c,g]);g&&d.debug&&h("report timeout, network infomation",t)},complete:function(b,c){E({eventid:ta,labelmap:JSON.stringify(t),duration:"1"},z);k(a.complete,b,[b,c])}}),d.debug&&h("report data:",c))}}function L(a){a=m(a);try{var b=JSON.parse(r.getItem(a));return Array.isArray(b)?b:[]}catch(c){return r.removeItem(a),[]}}function E(a,b){b=m(b);var c=L(b);Array.isArray(a)?a.forEach(function(a){return c.push(a)}):
c.push(a);r.setItem(b,JSON.stringify(c))}function ua(){g.addEventListener&&g.addEventListener("error",function(a){k(function(){if(v.isReportAllowed(a.filename)){v.count+=1;var b={};["colno","filename","lineno","message"].forEach(function(c){return b[c]=a[c]||"0"});var c=a.error||{};b.stack=c.stack||"";b.type=c.name||"Error";b.timestamp=parseInt(a.timeStamp/1E3);E(b,D)}})},!1)}function va(){k(function(){if(g[F])g[F]=null;else if("function"===typeof define&&define.amd)require.undef(F);else if("object"===
typeof q&&"undefined"!==typeof module){var a=require.resolve(F);delete require.cache[a]}else h("unknown module system, unload DCAgent manually please");h("DCAgent has been destroyed.")})}function wa(){if(Z)return va(),!1;p.hidden||(d.intervalCount+=1,B.setItem(m(N),d.intervalCount),T());return!0}function O(a,b){if(!w.isAgentReady()){var c=[a];[].forEach.call(b,function(a){return c.push(a)});G.push(c);return!0}}function xa(a){a=m(a);try{var b=JSON.parse(r.getItem(a));return Array.isArray(b)?b:[]}catch(c){return r.removeItem(a),
[]}}function ya(a,b){b=m(b);var c=xa(b);Array.isArray(a)?a.forEach(function(a){return c.push(a)}):c.push(a);r.setItem(b,JSON.stringify(c))}function $(a,b,c){if(!a)h("invoke failed, missing eventId");else if(!O("onEvent",arguments)){null==b&&(b=0);var e,d;if(c&&"[object Object]"===za.call(c)){for(e in c)d=c[e],c[e]=encodeURIComponent(d);e=JSON.stringify(c)}else e="";ya({eventid:a,duration:String(b),labelmap:e},z)}}function aa(a){O("onPageView",arguments)||W(a)}function ba(a){a&&a.hasOwnProperty("amount")&&
!O("onPayment",arguments)&&(a.amount=parseFloat(a.amount)||0,U({data:{payment:{currencyAmount:a.amount.toFixed(2),currencyType:a.currencyType||"CNY",payType:String(a.payType||""),iapid:String(a.iapid||""),orderId:String(a.orderId||""),payTime:String(a.payTime||"")}}},V))}function ca(a,b,c,e){b&&y(K,a);d.deviceId=a;d.accountId=d.accountId||a;var f=B.getItem(m(da));f||(f=Date.now(),B.setItem(m(da),f));d.loginTime=f;f=B.getItem(m(N));f||(f="0",B.setItem(m(N),f));d.intervalCount=parseInt(f);d.interval=
1E3*Math.max(10,parseFloat(c.interval||d.interval));d.virus&&Aa(a);c.errorReport&&(c.excludes&&(v.excludes=v.excludes.concat(c.excludes)),ua());c=null;b&&(c={isact:b,isreg:1},d.parentId&&(c.parentid=d.parentId),s.localStorage||(c.localstorage=1));d.initializedOn=Date.now()/1E3;C(A)||y(A,d.initializedOn);W(null,c,function(){w.setReadyState(3);for(var b={onEvent:$,onPageView:aa,onPayment:ba},c=0,f=G.length;c<f;c++){var h=G[c];b[h.shift()].apply(g,h)}G.length=0;ja(wa,d.interval);"function"===typeof e&&
e(a)})}function Ba(a){function b(c){k(function(){if(0===ea.indexOf(c.origin)){var e=JSON.parse(c.data);g.removeEventListener("message",b,!1);y(A,e.crtime);a(e.id)}})}g.addEventListener("message",b,!1);var c=p.createElement("iframe");c.style.display="none";c.src=ea;c.onload=function(){this.onload=null;this.parentNode.removeChild(this)};var e=function(){return p.body.appendChild(c)};p.body?e():p.addEventListener("DOMContentLoaded",e,!1)}function Ca(a){y(A,parseInt(Date.now()/1E3));var b;b=s.engine.egret?
fa+Da:fa+Ea;a(ha(b))}var x=(0,eval)("this"),g=x||{},p=x.document||{},u=x.location||{},d={appId:"",deviceId:"",accountId:"",channel:"",appVer:"",interval:10,intervalCount:0,loginTime:0,debug:g.DCAGENT_DEBUG_OPEN},s={get engine(){return P},get localStorage(){return Fa},get sessionStorage(){return Ga},get postMessage(){return Ha},get realBrowser(){return J},get cookie(){return Ia}},l;"function"===typeof p.createElement&&(x=p.createElement("div"),x.innerHTML="<i></i>","function"===typeof x.querySelector&&
(l=x.querySelector("i"),l=!!l&&"I"===l.tagName));var P={egret:"undefined"!==typeof egret},Fa=!!g.localStorage||!!P.egret,Ga=!!g.sessionStorage,Ha=!!g.postMessage,J=!!l,Ia=J&&"cookie"in p,I=g.setTimeout;P.egret&&(I=function(a,b){egret.setTimeout(a,g,b)});var za=Object.prototype.toString;l={getItem:n,setItem:n,removeItem:n};var r=s.localStorage?g.localStorage:l,B=s.sessionStorage?g.sessionStorage:l;s.engine.egret&&(r=egret.localStorage);var A="dcagent_create_time",fa="ND",Da="EGRET",Ea="UE",S="dcagent_parent_id",
z="dcagent_client_events",D="dcagent_client_errors",da="dcagent_login_time",N="dcagent_interval_key",K="dcagent_client_id",V="http://rd.gdatacube.net/dc/html5/sync",ea="http://rd.gdatacube.net/dc/html5/whoami",ta="_DESelf_OSS",Y=3E4,F="DCAgent",ra=172800,ga,R=ga=s.cookie?{get:function(a){return(a=p.cookie.match(new RegExp("(^|)\\s*"+a+"=([^\\s]*)")))&&3<=a.length?decodeURIComponent(a[2]):null},set:function(a,b,c,e,d,g){var h;c&&(h=new Date,h.setTime(h.getTime()+864E5*c));c=c?" expires="+h.toGMTString():
"";d=" path="+(d||"/");e=e?" domain="+e:"";g=g?" secure":"";p.cookie=a+"="+encodeURIComponent(b)+c+d+e+g},remove:function(a,b,c){ga.set(a,"",-1,b,c)}}:{get:n,set:n,remove:n},Aa=s.realBrowser?ka:n,H={max:100,count:0,excludes:[],isReportAllowed:function(a){if(H.count<H.max)return H.excludes.every(function(b){return-1===a.indexOf(b)})}},v=H,M=0,la=s.realBrowser?u.pathname+u.search:"/",X="14";q.version=X;l=g.screen||{};var oa=l.width?l.width+"*"+l.height:"0*0",na=p.domain||"",t={succ:0,fail:0,total:0},
sa=function(){if(g.XMLHttpRequest)return pa;if(s.engine.egret)return qa;h("unknow platform, http request is not support");return n}(),Z=!1;q.teardown=function(){Z=!0};var Q=0,w={getReadyState:function(){return Q},setReadyState:function(a){Q=a},isAgentReady:function(){return 3===Q}},G=[];q.onEvent=$;q.onPageView=aa;q.onPayment=ba;var Ja=s.postMessage&&s.realBrowser?Ba:Ca;q.init=function(a,b){if(0<w.getReadyState())h("DCAgent.init should be called only once");else if(a=a||{},a.appId){["errorReport",
"virus"].forEach(function(b){return d[b]=a.hasOwnProperty(b)?!!a[b]:!0});["appId","accountId","appVer"].forEach(function(b){return d[b]=a[b]||""});d.channel=a.channel||p.referrer||"";var c=C(K);c?ca(c,0,a,b):(w.setReadyState(1),Ja(function(c){w.setReadyState(2);ca(c,1,a,b)}))}else h("init failed, missing appId")};l=w.isAgentReady;Object.defineProperty(q,"readyState",{get:function(){h("DCAgent.readyState is obsolete, use DCAgent.isReady() instead");return w.getReadyState()}});q.isReady=l});
